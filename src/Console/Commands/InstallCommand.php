<?php

namespace SiteManager\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\DB;

class InstallCommand extends Command
{
    protected $signature = 'sitemanager:install 
                            {--force : Force the operation to run when in production}
                            {--with-starter : Publish starter templates for front-end development}';
    
    protected $description = 'Install SiteManager package with all required setup';

    public function handle()
    {
        $this->info('üöÄ Installing SiteManager Package...');
        $this->newLine();
        
        // 1. Í∏∞Ï°¥ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î∞±ÏóÖ
        $this->backupExistingMigrations();
        
        // 2. ÏÑ§Ï†ï ÌååÏùº Î∞úÌñâ
        $this->publishConfig();
        
        // 3. ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î∞úÌñâ Î∞è Ïã§Ìñâ
        $this->publishAndRunMigrations();
        
        // 4. Ïñ∏Ïñ¥ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
        $this->restoreLanguageData();
        
        // 5. Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ Î∞úÌñâ
        $this->publishImages();
        
        // 6. Ìôà ÎùºÏö∞Ìä∏ ÏÑ§Ï†ï
        $this->info('üè† Setting up home route...');
        $this->setupHomeRoute();
        
        // 7. ÏôÑÎ£å Î©îÏãúÏßÄ
        $this->displayCompletionMessage();
        
        return 0;
    }

    /**
     * Í∏∞Ï°¥ Laravel ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏùÑ Î∞±ÏóÖÌïòÍ≥† SiteManager Ï†ÑÏö©ÏúºÎ°ú Ï†ïÎ¶¨Ìï©ÎãàÎã§.
     */
    protected function backupExistingMigrations(): void
    {
        $migrationPath = database_path('migrations');
        $backupPath = database_path('migrations.backup');
        
        if (!is_dir($migrationPath)) {
            $this->line('üìÅ No migrations folder found, creating new one...');
            File::makeDirectory($migrationPath, 0755, true);
            return;
        }
        
        $files = File::files($migrationPath);
        
        if (empty($files)) {
            $this->line('üìÅ No migration files found to backup.');
            return;
        }
        
        $this->warn('üìã Found existing migrations (Laravel defaults like users/cache/jobs not needed for SiteManager)');
        $this->line('   üí° SiteManager uses Member model and file-based cache/queue');
        $this->newLine();
        
        if ($this->option('force') || $this->confirm('üóÇÔ∏è  Backup existing migrations to migrations.backup?', true)) {
            // Î∞±ÏóÖ Ìè¥ÎçîÍ∞Ä Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (is_dir($backupPath)) {
                File::deleteDirectory($backupPath);
            }
            
            // ÌòÑÏû¨ migrations Ìè¥ÎçîÎ•º backupÏúºÎ°ú Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
            File::move($migrationPath, $backupPath);
            
            // ÏÉàÎ°úÏö¥ migrations Ìè¥Îçî ÏÉùÏÑ±
            File::makeDirectory($migrationPath, 0755, true);
            
            $this->info("   ‚úÖ Backed up " . count($files) . " migration files to migrations.backup/");
            $this->line('   üìù Starting fresh with SiteManager-only migrations');
        } else {
            $this->line('   ‚è≠Ô∏è  Skipped migration backup.');
        }
        
        $this->newLine();
    }

    /**
     * ÏÑ§Ï†ï ÌååÏùºÏùÑ Î∞úÌñâÌï©ÎãàÎã§.
     */
    protected function publishConfig(): void
    {
        $this->info('üì¶ Publishing configuration files...');
        
        Artisan::call('vendor:publish', [
            '--tag' => 'sitemanager-config',
            '--force' => $this->option('force')
        ]);
        
        $this->line('   ‚úÖ Configuration files published');
        $this->newLine();
    }

    /**
     * SiteManager ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏùÑ ÏßÅÏ†ë Ïã§ÌñâÌï©ÎãàÎã§.
     */
    protected function publishAndRunMigrations(): void
    {
        $this->info('üîÑ Running SiteManager migrations...');
        
        // Ìå®ÌÇ§ÏßÄ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Í≤ΩÎ°ú ÏûêÎèô Í∞êÏßÄ
        $migrationPath = $this->getPackageMigrationPath();
        
        if (!$migrationPath || !is_dir($migrationPath)) {
            $this->warn('   ‚ö†Ô∏è  Direct migration execution failed. Trying publish method...');
            $this->publishMigrationsAndRun();
            return;
        }
        
        $this->line('   üìÅ Migration path found: ' . $migrationPath);
        
        try {
            // vendor ÎÇ¥Ïùò ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏùÑ ÏßÅÏ†ë Ïã§Ìñâ
            Artisan::call('migrate', [
                '--path' => $migrationPath,
                '--force' => $this->option('force')
            ]);
            
            $this->line('   ‚úÖ SiteManager migrations executed successfully');
        } catch (\Exception $e) {
            $this->warn('   ‚ö†Ô∏è  Direct migration failed: ' . $e->getMessage());
            $this->line('   ÔøΩ Trying publish method as fallback...');
            $this->publishMigrationsAndRun();
        }
        
        $this->newLine();
    }

    /**
     * ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏùÑ Î∞úÌñâÌïú ÌõÑ Ïã§ÌñâÌï©ÎãàÎã§ (fallback Î∞©Î≤ï).
     */
    protected function publishMigrationsAndRun(): void
    {
        try {
            // ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î∞úÌñâ
            $this->line('   üì¶ Publishing migrations to database/migrations...');
            Artisan::call('vendor:publish', [
                '--tag' => 'sitemanager-migrations',
                '--force' => $this->option('force')
            ]);
            
            // Î∞úÌñâÎêú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
            $this->line('   üîÑ Running published migrations...');
            Artisan::call('migrate', [
                '--force' => $this->option('force')
            ]);
            
            $this->line('   ‚úÖ Migrations published and executed successfully');
            
        } catch (\Exception $e) {
            $this->error('   ‚ùå Migration execution failed: ' . $e->getMessage());
            throw new \Exception('Unable to execute SiteManager migrations. Installation aborted.');
        }
    }

    /**
     * Ìå®ÌÇ§ÏßÄ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Í≤ΩÎ°úÎ•º ÏûêÎèôÏúºÎ°ú Í∞êÏßÄÌï©ÎãàÎã§.
     */
    protected function getPackageMigrationPath(): ?string
    {
        $possiblePaths = [];
        
        // 1. ÌòÑÏû¨ ÌååÏùº Í∏∞Ï§ÄÏúºÎ°ú ÏÉÅÎåÄ Í≤ΩÎ°ú Í≥ÑÏÇ∞ (Í∞úÎ∞úÌôòÍ≤Ω)
        $relativePath = __DIR__ . '/../../../database/migrations';
        $possiblePaths['relative'] = $relativePath;
        if (is_dir($relativePath)) {
            $realPath = realpath($relativePath);
            $this->line('   ‚úÖ Found migration path (relative): ' . $realPath);
            return $realPath;
        }
        
        // 2. Composer vendor Í≤ΩÎ°ú (ÏÑ§ÏπòÎêú Ìå®ÌÇ§ÏßÄ)
        $vendorPath = base_path('vendor/d3141cgit/sitemanager/database/migrations');
        $possiblePaths['vendor'] = $vendorPath;
        if (is_dir($vendorPath)) {
            $this->line('   ‚úÖ Found migration path (vendor): ' . $vendorPath);
            return $vendorPath;
        }
        
        // 3. Ìå®ÌÇ§ÏßÄ ÎîîÏä§Ïª§Î≤ÑÎ¶¨Î•º ÌÜµÌïú Í≤ΩÎ°ú Ï∞æÍ∏∞
        try {
            $reflection = new \ReflectionClass(\SiteManager\SiteManagerServiceProvider::class);
            $packagePath = dirname($reflection->getFileName());
            $migrationPath = $packagePath . '/../database/migrations';
            $possiblePaths['reflection'] = $migrationPath;
            
            if (is_dir($migrationPath)) {
                $realPath = realpath($migrationPath);
                $this->line('   ‚úÖ Found migration path (reflection): ' . $realPath);
                return $realPath;
            }
        } catch (\Exception $e) {
            $possiblePaths['reflection_error'] = $e->getMessage();
        }
        
        // 4. ServiceProviderÏóêÏÑú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Í≤ΩÎ°ú ÌôïÏù∏
        try {
            $serviceProvider = app(\SiteManager\SiteManagerServiceProvider::class);
            // SiteManagerServiceProviderÏóêÏÑú loadMigrationsFrom Ìò∏Ï∂úÌïòÎäî Í≤ΩÎ°ú ÌôïÏù∏
            $providerPath = (new \ReflectionClass($serviceProvider))->getFileName();
            $packageRoot = dirname(dirname(dirname($providerPath)));
            $migrationPath = $packageRoot . '/database/migrations';
            $possiblePaths['service_provider'] = $migrationPath;
            
            if (is_dir($migrationPath)) {
                $realPath = realpath($migrationPath);
                $this->line('   ‚úÖ Found migration path (service provider): ' . $realPath);
                return $realPath;
            }
        } catch (\Exception $e) {
            $possiblePaths['service_provider_error'] = $e->getMessage();
        }
        
        // 5. Î™®Îì† vendor ÎîîÎ†âÌÜ†Î¶¨ Ïä§Ï∫î
        $vendorDir = base_path('vendor');
        if (is_dir($vendorDir)) {
            $searchPaths = [
                $vendorDir . '/d3141cgit/sitemanager/database/migrations',
                $vendorDir . '/*/sitemanager/database/migrations'
            ];
            
            foreach ($searchPaths as $searchPath) {
                $possiblePaths['vendor_scan_' . basename(dirname($searchPath))] = $searchPath;
                if (is_dir($searchPath)) {
                    $realPath = realpath($searchPath);
                    $this->line('   ‚úÖ Found migration path (vendor scan): ' . $realPath);
                    return $realPath;
                }
            }
        }
        
        // ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ Ï∂úÎ†•
        $this->warn('   ‚ùå No migration paths found. Searched locations:');
        foreach ($possiblePaths as $type => $path) {
            $status = is_string($path) && is_dir($path) ? '‚úÖ' : '‚ùå';
            $this->line("      {$status} {$type}: {$path}");
        }
        
        return null;
    }

    /**
     * Ïñ∏Ïñ¥ Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌï©ÎãàÎã§.
     */
    protected function restoreLanguageData(): void
    {
        $this->info('üåç Restoring language data...');
        
        // ÌÖåÏù¥Î∏î Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
        try {
            if (!$this->checkTablesExist()) {
                $this->warn('   ‚ö†Ô∏è  Required tables not found. Skipping language data restoration.');
                $this->line('   üí° Run "php artisan sitemanager:restore-languages" after ensuring tables exist.');
                $this->newLine();
                return;
            }
        } catch (\Exception $e) {
            $this->warn('   ‚ö†Ô∏è  Cannot verify table existence: ' . $e->getMessage());
            $this->line('   üí° Attempting language restoration anyway...');
        }
        
        try {
            $exitCode = Artisan::call('sitemanager:restore-languages', [
                '--force' => true
            ]);
            
            if ($exitCode === 0) {
                $this->line('   ‚úÖ Language data restored successfully');
            } else {
                $this->warn('   ‚ö†Ô∏è  Language data restoration failed (exit code: ' . $exitCode . ')');
                $this->line('   üí° You can retry with: php artisan sitemanager:restore-languages');
            }
        } catch (\Exception $e) {
            $this->warn('   ‚ö†Ô∏è  Language data restoration failed: ' . $e->getMessage());
            $this->line('   üí° You can retry with: php artisan sitemanager:restore-languages');
        }
        
        $this->newLine();
    }

    /**
     * ÌïÑÏöîÌïú ÌÖåÏù¥Î∏îÎì§Ïù¥ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§.
     */
    protected function checkTablesExist(): bool
    {
        $requiredTables = ['languages', 'menus', 'members'];
        
        foreach ($requiredTables as $table) {
            if (!DB::getSchemaBuilder()->hasTable($table)) {
                $this->line("   ‚ùå Table '{$table}' not found");
                return false;
            }
        }
        
        $this->line('   ‚úÖ All required tables exist');
        return true;
    }

    /**
     * Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄÎ•º Î∞úÌñâÌï©ÎãàÎã§.
     */
    protected function publishImages(): void
    {
        $this->info('üñºÔ∏è  Publishing admin images...');
        
        Artisan::call('vendor:publish', [
            '--tag' => 'sitemanager-images',
            '--force' => $this->option('force')
        ]);
        
        $this->line('   ‚úÖ Admin images published to public/images/');
        $this->newLine();
    }

    /**
     * ÏôÑÎ£å Î©îÏãúÏßÄÎ•º ÌëúÏãúÌï©ÎãàÎã§.
     */
    protected function displayCompletionMessage(): void
    {
        $this->newLine();
        $this->info('üéâ SiteManager installation completed!');
        $this->newLine();
        
        $this->line('üìã <comment>What was done:</comment>');
        $this->line('   ‚Ä¢ Backed up existing Laravel migrations (users/cache/jobs not needed)');
        $this->line('   ‚Ä¢ Published SiteManager configuration files');
        $this->line('   ‚Ä¢ Executed SiteManager migrations from vendor directory');
        $this->line('   ‚Ä¢ Verified table creation before data restoration');
        $this->line('   ‚Ä¢ Restored language data from SQL dump');
        $this->line('   ‚Ä¢ Published SiteManager images');
        $this->line('   ‚Ä¢ Backed up original routes and created new web.php');
        $this->newLine();
        
        $this->line('üéØ <comment>Next steps:</comment>');
        $this->line('   1. Create an admin user: <info>php artisan sitemanager:admin</info>');
        $this->line('   2. Visit <info>/</info> to see the main page');
        $this->line('   3. Visit <info>/sitemanager/dashboard</info> to access admin panel');
        $this->newLine();
        
        $this->line('‚öôÔ∏è <comment>Configuration completed:</comment>');
        $this->line('   ‚Ä¢ Member model configured for authentication');
        $this->line('   ‚Ä¢ SiteManager routes loaded');
        $this->line('   ‚Ä¢ Admin middleware configured');
        $this->newLine();
        
        $this->line('üîß <comment>Resource management:</comment>');
        $this->line('   ‚Ä¢ Use: <info>{!! resource(\'sitemanager::css/sitemanager/sitemanager.css\') !!}</info>');
        $this->line('   ‚Ä¢ Build for production: <info>php artisan resource build</info>');
        $this->line('   ‚Ä¢ Clear resources: <info>php artisan resource clear</info>');
        $this->newLine();
        
        if (is_dir(database_path('migrations.backup'))) {
            $this->line('üíæ <comment>Backup info:</comment>');
            $this->line('   ‚Ä¢ Original migrations saved in: <info>database/migrations.backup/</info>');
            $this->line('   ‚Ä¢ Restore if needed: <info>mv database/migrations.backup/* database/migrations/</info>');
            $this->newLine();
        }
        
        if (file_exists(base_path('routes/web.php.backup'))) {
            $this->line('üìÑ <comment>Routes backup:</comment>');
            $this->line('   ‚Ä¢ Original routes saved in: <info>routes/web.php.backup</info>');
            $this->line('   ‚Ä¢ Restore if needed: <info>mv routes/web.php.backup routes/web.php</info>');
            $this->newLine();
        }
    }

    /**
     * Ìôà ÎùºÏö∞Ìä∏Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§.
     */
    protected function setupHomeRoute(): void
    {
        $webRoutesPath = base_path('routes/web.php');
        $backupPath = base_path('routes/web.php.backup');
        
        // web.php ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
        if (!file_exists($webRoutesPath)) {
            $this->createNewWebRoutes($webRoutesPath);
            return;
        }
        
        // Í∏∞Ï°¥ web.php Î∞±ÏóÖ
        if ($this->option('force') || $this->confirm('üóÇÔ∏è  Backup existing routes/web.php?', true)) {
            // Í∏∞Ï°¥ Î∞±ÏóÖÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (file_exists($backupPath)) {
                unlink($backupPath);
            }
            
            // ÌòÑÏû¨ web.phpÎ•º Î∞±ÏóÖÏúºÎ°ú Î≥µÏÇ¨
            copy($webRoutesPath, $backupPath);
            
            // ÏÉàÎ°úÏö¥ web.php ÏÉùÏÑ±
            $this->createNewWebRoutes($webRoutesPath);
            
            $this->line('   ‚úÖ Backed up routes/web.php to web.php.backup');
            $this->line('   ‚úÖ Created new routes/web.php with SiteManager routes');
        } else {
            $this->line('   ‚è≠Ô∏è  Skipped routes backup, keeping existing routes/web.php');
        }
    }

    /**
     * ÏÉàÎ°úÏö¥ web.php ÌååÏùºÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.
     */
    protected function createNewWebRoutes(string $webRoutesPath): void
    {
        $webRoutesContent = "<?php

use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
|
| Here is where you can register web routes for your application. These
| routes are loaded by the RouteServiceProvider within a group which
| contains the \"web\" middleware group. Now create something great!
|
*/

// SiteManager ÌôàÌéòÏù¥ÏßÄ
Route::get('/', function () {
    return view('sitemanager::main');
})->name('home');

// ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÎùºÏö∞Ìä∏Î•º ÏïÑÎûòÏóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
// Route::get('/about', [AboutController::class, 'index'])->name('about');
";
        
        file_put_contents($webRoutesPath, $webRoutesContent);
    }
}
